---
title: "Certification: Caseflow Use After CSS Transition"
output: 
  html_notebook: 
    code_folding: hide
---

```{r include = FALSE}
source("../R/vacolsConnect.R")
library("dplyr")
library("tidyr")
library("knitr")
library("scales")

con <- vacolsConnect()
```

## Objective

Compare RO use of Caseflow before and after the CSS transition.

Only includes paperless (VBMS) cases. Pre-CSS group includes certifications since July 1, 2016.

```{r}
ro <- read.csv("../data/ro.csv", stringsAsFactors = FALSE)

uptake <- dbGetQuery(con, "
  select
    BF41STAT,
    BFDCERTOOL,
    BFREGOFF
  
  from BRIEFF
  
  join FOLDER
    on BFKEY = TICKNUM
  
  where TIVBMS in ('Y', '1', '0')
    and BF41STAT >= date '2016-07-01'
") %>%
  mutate(
    caseflow = ifelse(is.na(BFDCERTOOL), "Not_Caseflow", "Caseflow"),
    group = ifelse(BF41STAT < as.POSIXct("2016-10-17"), "pre", "post")
  ) %>%
  count(BFREGOFF, caseflow, group) %>%
  spread(caseflow, n, fill = 0) %>%
  ungroup() %>%
  transmute(
    BFREGOFF,
    group,
    Percent_Caseflow = Caseflow / (Caseflow + Not_Caseflow)
  ) %>%
  spread(group, Percent_Caseflow) %>%
  mutate(
    change = round((post - pre) * 100),
    pre = percent(pre),
    post = percent(post)
  ) %>%
  left_join(ro, by = c("BFREGOFF")) %>%
  select(-Station) %>%
  arrange(change)

uptake$change <- ifelse(uptake$change > 0, paste0("+", uptake$change), uptake$change)

kable(uptake)
```
